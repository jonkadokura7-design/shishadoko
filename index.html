<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シーシャどこ？ | Shisha Doko</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="public/favicon.png">

    <style>
        :root {
            --primary: #fbbf24;
            /* Amber 400 */
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #1a1025;
            /* Deep purple bg */
            color: #f3f4f6;
            min-height: 100vh;
            background-image: url('./public/shisha-bg.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden;
        }

        /* Dark Overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 10, 25, 0.85);
            z-index: -1;
        }

        /* Glassmorphism */
        .glass-card {
            background: rgba(40, 30, 60, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 215, 0, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Typography */
        .text-gold-gradient {
            background: linear-gradient(to right, #fde68a, #fbbf24, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Glow Button */
        .glow-btn {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
        }

        .glow-btn:hover {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.7);
            transform: translateY(-2px);
        }

        /* Smoke Animation Support */
        @keyframes drift {
            0% {
                transform: translateY(0) scale(0.5) translateX(-50%);
                opacity: 0;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                transform: translateY(-100px) scale(2) translateX(-20%);
                opacity: 0;
            }
        }

        .smoke-particle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 50px;
            height: 50px;
            background: rgba(128, 128, 128, 0.3);
            border-radius: 50%;
            filter: blur(20px);
            animation: drift 3s infinite ease-in-out;
            pointer-events: none;
        }

        /* Modal Animation */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center p-4">

    <!-- Screen 1: Landing -->
    <div id="landing-screen"
        class="flex flex-col items-center justify-center w-full max-w-lg transition-opacity duration-500">
        <div class="mb-8 text-center space-y-4">
            <!-- Decorative BG Elements -->
            <div
                class="fixed top-[-10%] left-[-10%] w-[50vh] h-[50vh] bg-purple-900/20 rounded-full blur-[100px] pointer-events-none">
            </div>

            <h1 class="text-5xl md:text-7xl font-bold tracking-tighter text-gold-gradient drop-shadow-lg pb-2">
                シーシャどこ？
            </h1>
            <p class="text-lg text-gray-400 font-medium tracking-wide">
                現在地から、最高のシーシャ体験を。
            </p>
        </div>

        <button onclick="startSearch()"
            class="group relative inline-flex h-14 w-64 items-center justify-center overflow-hidden rounded-full bg-amber-500 px-6 font-medium text-neutral-950 transition-all duration-300 hover:scale-105 hover:bg-amber-400 focus:outline-none glow-btn shadow-lg z-10">
            <i data-lucide="map-pin" class="mr-2 h-5 w-5"></i>
            <span class="tracking-wider text-lg">今すぐ探す</span>
        </button>

        <!-- Divider -->
        <div class="relative w-full max-w-xs my-6 flex items-center justify-center">
            <div class="absolute inset-0 flex items-center">
                <div class="w-full border-t border-gray-600"></div>
            </div>
            <div class="relative bg-[#1a1025] px-4 text-sm text-gray-400">または</div>
        </div>

        <!-- Station Search -->
        <div class="w-full max-w-xs flex flex-col gap-2 relative z-0">
            <div class="relative group">
                <input type="text" id="station-input" placeholder="駅名を入力 (例: 渋谷駅)"
                    class="w-full h-12 rounded-lg bg-white/10 border border-white/20 px-4 text-white placeholder-gray-400 focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-all text-center backdrop-blur-sm">
                <div
                    class="absolute inset-0 rounded-lg bg-gradient-to-r from-amber-500/20 to-purple-500/20 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none -z-10 blur-sm">
                </div>
            </div>
            <button onclick="startStationSearch()"
                class="h-10 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-amber-500 transition-all text-sm font-medium flex items-center justify-center gap-2 hover:border-amber-500/50">
                <i data-lucide="search" class="w-4 h-4"></i>
                <span>駅から探す (1km圏内)</span>
            </button>
        </div>


    </div>

    <!-- Screen 2: Loading (Hidden by default) -->
    <div id="loading-screen" class="hidden flex-col items-center justify-center w-full h-64">
        <div class="relative h-64 w-full flex justify-center items-end">
            <div class="smoke-particle" style="animation-delay: 0s;"></div>
            <div class="smoke-particle" style="animation-delay: 1s;"></div>
            <div class="smoke-particle" style="animation-delay: 2s;"></div>

            <!-- Shisha Base Icon Placeholder -->
            <div
                class="w-8 h-12 border-2 border-amber-500/50 rounded-b-xl relative z-10 bg-slate-900/50 backdrop-blur-sm mb-12">
                <div class="absolute bottom-0 w-full h-1/2 bg-amber-500/20 rounded-b-lg animate-pulse"></div>
            </div>
        </div>
        <p class="text-amber-200/80 font-light tracking-widest text-sm animate-pulse mt-4">検索中...</p>
    </div>

    <!-- Screen 3: Results (Hidden by default) -->
    <div id="results-screen" class="hidden w-full max-w-xl pb-20">
        <div class="flex items-center mb-6 pt-4">
            <button onclick="goBack()" class="mr-4 p-2 rounded-full hover:bg-white/10 transition-colors">
                <i data-lucide="arrow-left" class="w-6 h-6 text-amber-500"></i>
            </button>
            <h1 class="text-2xl font-bold text-gold-gradient">近くのシーシャ屋</h1>
        </div>

        <div id="results-container" class="space-y-4">
            <!-- Cards will be injected here -->
        </div>

        <div id="error-message" class="hidden text-center py-8 text-red-400">
            <p>位置情報を取得できませんでした。</p>
            <button onclick="startSearch()" class="mt-4 underline">再試行</button>
        </div>
    </div>

    <!-- Shop Detail Modal -->
    <div id="shop-detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- Overlay -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeShopModal()"></div>

        <!-- Modal Content -->
        <div
            class="glass-card w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-2xl p-6 relative z-10 animate-fade-in">
            <button onclick="closeShopModal()"
                class="absolute top-4 right-4 p-2 rounded-full bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div id="modal-content" class="space-y-6">
                <!-- Header -->
                <div>
                    <h2 id="modal-shop-name"
                        class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-100 to-amber-400 mb-2 mr-8">
                        Shop Name</h2>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="flex items-center" id="modal-stars"></div>
                        <span class="text-gray-400" id="modal-reviews">(0)</span>
                        <span id="modal-status-badge"
                            class="ml-2 text-xs px-2 py-0.5 rounded-full border border-green-500/50 text-green-400 bg-green-900/20">営業中</span>
                    </div>
                </div>

                <!-- Action Button -->
                <button id="modal-directions-btn"
                    class="w-full group relative inline-flex h-12 items-center justify-center overflow-hidden rounded-xl bg-amber-500 px-6 font-medium text-neutral-950 transition-all duration-300 hover:bg-amber-400 focus:outline-none glow-btn">
                    <i data-lucide="navigation" class="mr-2 h-5 w-5"></i>
                    <span class="tracking-wide">このお店に行く (Google Maps)</span>
                </button>

                <!-- Info List -->
                <div class="space-y-4 text-sm text-gray-300">
                    <!-- Address -->
                    <div class="flex items-start gap-3 p-3 rounded-lg bg-white/5 border border-white/5">
                        <i data-lucide="map-pin" class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"></i>
                        <span id="modal-address" class="break-words">Address...</span>
                    </div>

                    <!-- Hours -->
                    <div class="flex items-start gap-3 p-3 rounded-lg bg-white/5 border border-white/5">
                        <i data-lucide="clock" class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"></i>
                        <div>
                            <span class="block text-amber-500 font-medium mb-1">営業時間</span>
                            <ul id="modal-hours" class="space-y-1 text-xs text-gray-400">
                                <!-- Hours lines injected here -->
                                <li>Loading...</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Phone -->
                    <div id="modal-phone-container"
                        class="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/5">
                        <i data-lucide="phone" class="w-5 h-5 text-amber-500 flex-shrink-0"></i>
                        <a id="modal-phone" href="#" class="hover:text-amber-400 transition-colors">03-0000-0000</a>
                    </div>

                    <!-- Website -->
                    <div id="modal-website-container"
                        class="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/5">
                        <i data-lucide="globe" class="w-5 h-5 text-amber-500 flex-shrink-0"></i>
                        <a id="modal-website" href="#" target="_blank" rel="noopener noreferrer"
                            class="hover:text-amber-400 transition-colors break-all">Website URL</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        let map;
        let service;
        let userLat, userLng;
        let isApiLoaded = false;

        // APIロード後の初期化
        window.initMap = function () {
            const mapNode = document.createElement('div');
            // 初期座標は仮（東京）
            map = new google.maps.Map(mapNode, { center: { lat: 35.6895, lng: 139.6917 }, zoom: 15 });
            service = new google.maps.places.PlacesService(map);
            isApiLoaded = true;
        }

        // --- Mock Data (Fallback) ---
        // APIキー未設定時用のデモデータ（1km圏内想定）
        // --- Mock Data (Fallback) ---
        // APIキー未設定時用のデモデータ
        const MOCK_PLACES = [
            {
                name: '【デモ】シーシャカフェ 渋谷店',
                rating: 4.8,
                reviews: 120,
                address: '東京都渋谷区...',
                isOpen: true,
                distance: 0.3, // 一番近い
                place_id: '',
                topReview: 'とても落ち着く空間でした。フレーバーの種類も豊富です。'
            },
            {
                name: '【デモ】Hookah Lounge 六本木',
                rating: 4.5,
                reviews: 85,
                address: '東京都港区...',
                isOpen: true,
                distance: 2.5,
                place_id: '',
                topReview: '深夜まで営業していて便利。'
            },
            {
                name: '【デモ】Chill Space 新宿',
                rating: 3.2,
                reviews: 40,
                address: '東京都新宿区...',
                isOpen: true,
                distance: 1.2,
                place_id: '',
                topReview: '駅近でアクセスが良い。'
            },
            {
                name: '【デモ】Shisha Bar 上野',
                rating: 4.0,
                reviews: 200,
                address: '東京都台東区...',
                isOpen: true,
                distance: 4.8, // 遠い
                place_id: '',
                topReview: '賑やかなお店です。'
            },
            {
                name: '【デモ】Hidden Gem 恵比寿',
                rating: 4.9,
                reviews: 10,
                address: '東京都渋谷区...',
                isOpen: true,
                distance: 1.8,
                place_id: '',
                topReview: '隠れ家的な雰囲気。デートにおすすめ。'
            },
            {
                name: '【デモ】遠すぎるシーシャ屋 (表示されないはず)',
                rating: 4.0,
                reviews: 5,
                address: '東京都...',
                isOpen: true,
                distance: 6.0, // 5km圏外
                place_id: '',
                topReview: '遠い...'
            }
        ];

        // 検索状態管理
        let searchMode = 'current'; // 'current' or 'station'
        let currentMaxDistance = 5.0; // Default 5km
        let currentSearchLocation = null; // {lat, lng}

        // 0. Station Search Input Enter Key Support
        document.getElementById('station-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                startStationSearch();
            }
        });

        // Station Search Function
        function startStationSearch() {
            const stationName = document.getElementById('station-input').value.trim();
            if (!stationName) {
                alert("駅名を入力してください。");
                return;
            }

            // Append "駅" if not present to improve search accuracy, though user might input it
            // const query = stationName.endsWith('駅') ? stationName : stationName + '駅';
            const query = stationName;

            showScreen('loading-screen');
            searchMode = 'station';
            currentMaxDistance = 1.0; // 1km radius for station search

            // API Check
            const scriptTag = document.getElementById('google-maps-script');
            if (scriptTag && scriptTag.src.includes('YOUR_API_KEY')) {
                console.warn("API Key not set. Forcing Mock Data for Station.");
                setTimeout(() => {
                    // Mock: Just return random subset or distance sort from "Station" (Mock Tokyo)
                    // For demo, we just show same mock data but title updated
                    renderResults(MOCK_PLACES.slice(0, 3), true);
                    showScreen('results-screen');
                    // Add station context to title
                    updateResultTitle(`${query}周辺のシーシャ屋`);
                }, 1500);
                return;
            }

            if (!isApiLoaded || !service) {
                // Retry or Fail
                console.warn("Google Maps API not ready.");
                // Fallback
                setTimeout(() => {
                    renderResults(MOCK_PLACES.slice(0, 3), true);
                    showScreen('results-screen');
                    updateResultTitle(`${query}周辺のシーシャ屋`);
                }, 1500);
                return;
            }

            // Geocode Station Name
            const request = {
                query: query,
                fields: ['name', 'geometry'],
            };

            // Use PlacesService FindPlaceFromQuery or Geocoder
            // Geocoder is better for "Shibuya Station" generally, but PlacesService works too.
            // Let's use PlacesService since we already initialized it.
            service.findPlaceFromQuery(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                    const location = results[0].geometry.location;
                    const lat = location.lat();
                    const lng = location.lng();
                    currentSearchLocation = { lat, lng };

                    fetchRealPlaces(currentSearchLocation, currentMaxDistance, `${results[0].name}周辺`);
                } else {
                    showError("駅が見つかりませんでした。別の名前で試してください。");
                }
            });
        }

        // 1. トップページで「今すぐ探す」のボタンを押すと現在地のGPS情報を求める
        function startSearch() {
            searchMode = 'current';
            currentMaxDistance = 5.0; // Set back to 5km for current location search
            showScreen('loading-screen');

            // Safety Check: API KeyがデフォルトのままならAPIを呼ばない
            const scriptTag = document.getElementById('google-maps-script');
            if (scriptTag && scriptTag.src.includes('YOUR_API_KEY')) {
                console.warn("API Key not set. Forcing Mock Data.");
                setTimeout(() => {
                    // Mock Data Sorting & Limiting
                    const sortedMock = MOCK_PLACES
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 5);
                    renderResults(sortedMock, true);
                    showScreen('results-screen');
                }, 1500);
                return;
            }

            if (!navigator.geolocation) {
                showError("お使いのブラウザは位置情報をサポートしていません。");
                return;
            }

            // タイムアウト設定 (30秒) + 高精度モード + キャッシュ無効
            const options = {
                enableHighAccuracy: true,
                timeout: 30000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // 2. そこで取得したGPS情報を元に...
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    const userLocation = { lat: userLat, lng: userLng };

                    // check isApiLoaded instead of just window.google
                    if (isApiLoaded && service) {
                        fetchRealPlaces(userLocation, currentMaxDistance, "近く");
                    } else {
                        console.warn("Google Maps API not ready. Using fallback.");
                        setTimeout(() => {
                            // Mock Data Sorting & Limiting
                            const sortedMock = MOCK_PLACES
                                .sort((a, b) => a.distance - b.distance)
                                .slice(0, 5);
                            renderResults(sortedMock, true);
                            showScreen('results-screen');
                        }, 1500);
                    }
                },
                (error) => {
                    console.warn("Location failed:", error);
                    let msg = "位置情報の取得に失敗しました。\n";

                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            msg += "エラー: 位置情報の利用が許可されていません。\nブラウザの設定でシーシャどこ？の位置情報利用を許可してください。";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            msg += "エラー: 現在地情報を取得できませんでした。\n電波状況の良い場所でお試しください。";
                            break;
                        case error.TIMEOUT:
                            msg += "エラー: タイムアウトしました。\nもう一度「今すぐ探す」を押してください。";
                            break;
                        default:
                            msg += "エラー: 原因不明のエラーが発生しました。(" + error.message + ")";
                            break;
                    }

                    // HTTPS check warning
                    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                        msg += "\n\n⚠️ 重要: セキュリティ上の理由から、この機能はHTTPS接続（GitHub Pagesなど）でしか動作しない可能性があります。";
                    }

                    alert(msg + "\n\nデモデータを表示します。");

                    // エラー時もデモデータを表示してあげるほうが親切
                    setTimeout(() => {
                        // Mock Data Sorting & Limiting
                        const sortedMock = MOCK_PLACES
                            .sort((a, b) => a.distance - b.distance)
                            .slice(0, 5);
                        renderResults(sortedMock, true);
                        showScreen('results-screen');
                    }, 1000);
                },
                options
            );
        }

        function fetchRealPlaces(location, maxDistanceKm = 5.0, locationLabel = "近く") {
            // 2. Googleマップで「シーシャ」と検索
            // "rankBy: DISTANCE" を使用して、人気順ではなく純粋な距離順で取得する
            // ※ rankBy: DISTANCE を使う場合、radiusは指定できません。
            const request = {
                location: location,
                keyword: 'シーシャ',
                rankBy: google.maps.places.RankBy.DISTANCE,
                openNow: true // 3. 営業中のお店のみ
            };

            try {
                service.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results) {

                        // データ整形とクライアントサイドフィルタリング
                        let candidates = results.map(place => {
                            const distanceKm = getDistanceFromLatLonInKm(
                                location.lat, location.lng,
                                place.geometry.location.lat(),
                                place.geometry.location.lng()
                            );
                            return {
                                name: place.name,
                                rating: place.rating || 0,
                                reviews: place.user_ratings_total || 0,
                                address: place.vicinity || place.formatted_address,
                                isOpen: place.opening_hours ? place.opening_hours.isOpen() : true,
                                distance: Math.round(distanceKm * 100) / 100,
                                place_id: place.place_id,
                                price_level: place.price_level, // Price Level取得
                                topReview: '読み込み中...',
                                geometry: place.geometry
                            };
                        });

                        // 2. レビュー制限を解除 (なるべく多く表示するため)
                        // 4. Distance Filtering (Variable)
                        candidates = candidates.filter(p => p.distance <= maxDistanceKm);

                        // 距離順にソート
                        candidates.sort((a, b) => a.distance - b.distance);

                        // 5. 最大5つまで表示
                        const finalResults = candidates.slice(0, 5);

                        // --- 詳細情報の取得 (レビュー・写真・価格・詳細) ---
                        const detailPromises = finalResults.map(place => {
                            return new Promise((resolve) => {
                                const detailRequest = {
                                    placeId: place.place_id,
                                    fields: ['reviews', 'photos', 'price_level', 'opening_hours', 'website', 'formatted_phone_number']
                                };
                                service.getDetails(detailRequest, (placeDetails, detailStatus) => {
                                    if (detailStatus === google.maps.places.PlacesServiceStatus.OK) {
                                        // 1. レビュー取得
                                        if (placeDetails.reviews && placeDetails.reviews.length > 0) {
                                            let reviewText = placeDetails.reviews[0].text;
                                            if (reviewText.length > 60) {
                                                reviewText = reviewText.substring(0, 60) + "...";
                                            }
                                            place.topReview = reviewText;
                                        } else {
                                            place.topReview = "（レビューがありません）";
                                        }

                                        // 2. 写真取得
                                        if (placeDetails.photos && placeDetails.photos.length > 0) {
                                            place.photoUrl = placeDetails.photos[0].getUrl({ maxWidth: 400 });
                                        }

                                        // 3. 価格帯取得 (詳細APIから補完)
                                        if (placeDetails.price_level !== undefined) {
                                            place.price_level = placeDetails.price_level;
                                        }

                                        // 4. 詳細情報 (モーダル用)
                                        place.opening_hours_detail = placeDetails.opening_hours;
                                        // Update isOpen using detailed info if available
                                        if (placeDetails.opening_hours) {
                                            if (placeDetails.opening_hours.open_now !== undefined) {
                                                place.isOpen = placeDetails.opening_hours.open_now;
                                            } else if (typeof placeDetails.opening_hours.isOpen === 'function') {
                                                try {
                                                    place.isOpen = placeDetails.opening_hours.isOpen();
                                                } catch (err) {
                                                    console.warn('Error checking open status:', err);
                                                }
                                            }
                                        }
                                        place.website = placeDetails.website;
                                        place.phone = placeDetails.formatted_phone_number;

                                    } else {
                                        place.topReview = "（詳細取得エラー）";
                                    }
                                    resolve(place);
                                });
                            });
                        });

                        // 全ての詳細取得が終わったら表示
                        Promise.all(detailPromises).then(updatedResults => {
                            renderResults(updatedResults, false);
                            updateResultTitle(`${locationLabel}のシーシャ屋`);
                            showScreen('results-screen');
                        });

                    } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                        // 4. お店がない場合
                        renderResults([], false);
                        updateResultTitle(`${locationLabel}のシーシャ屋`);
                        showScreen('results-screen');
                    } else {
                        console.error("Places Search failed:", status);
                        // エラー時はデモデータを表示
                        alert("検索エラー (Status: " + status + ")\nデモデータを表示します。");
                        setTimeout(() => {
                            renderResults(MOCK_PLACES, true);
                            showScreen('results-screen');
                        }, 1000);
                    }
                });
            } catch (e) {
                console.error("Service Error:", e);
                // Mock Data Sorting & Limiting
                const sortedMock = MOCK_PLACES
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 5);
                renderResults(sortedMock, true);
                showScreen('results-screen');
            }
        }

        // 6. お店をクリックするとGoogleマップで現在地からそのお店までの経路を表示
        function openDirections(name, place_id) {
            // 目的地へのルート検索URL
            // queryに店名、destination_place_idにIDを指定することで精度向上
            const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(name)}&destination_place_id=${place_id}`;
            window.open(url, '_blank');
        }

        function renderResults(places, isMock) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';

            if (isMock) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'bg-red-900/50 text-red-200 border border-red-500/50 p-4 rounded-lg mb-4 text-sm';
                alertDiv.innerHTML = '⚠️ <strong>注意:</strong> Google Maps APIなどが利用できないため、デモデータを表示しています。<br>YOUR_API_KEYの設定や通信環境を確認してください。';
                container.appendChild(alertDiv);
            }

            // 4. 1キロ圏内にお店がない場合は、「周辺にご紹介できるシーシャ屋はありません。」
            if (places.length === 0) {
                let distanceMsg = currentMaxDistance === 1.0 ? "1km圏内" : "5km圏内";
                container.innerHTML = `
                    <div class="text-center py-10 space-y-4">
                        <p class="text-lg text-gray-300 font-medium">周辺(${distanceMsg})にご紹介できるシーシャ屋はありません。</p>
                        <p class="text-sm text-gray-500">条件を変更するか、場所を変えて再度お試しください。</p>
                        <button onclick="goBack()" class="text-amber-500 underline hover:text-amber-400">条件変更</button>
                    </div>
                `;
                return;
            }

            places.forEach(place => {
                const card = document.createElement('div');
                card.className = 'glass-card rounded-xl p-6 mb-4 transform transition-all hover:scale-[1.02] hover:bg-white/5 border border-white/10 group animate-fade-in cursor-pointer relative overflow-hidden';

                // 6. クリックで詳細モーダル表示
                // card.onclick = () => openDirections(place.name, place.place_id);
                card.onclick = () => openShopModal(place);

                // Star generation
                const fullStars = Math.floor(place.rating);
                let starsHtml = '';
                for (let i = 0; i < fullStars; i++) starsHtml += '<i data-lucide="star" class="w-4 h-4 fill-amber-400 text-amber-400 inline"></i>';
                if (place.rating % 1 !== 0) starsHtml += '<i data-lucide="star-half" class="w-4 h-4 fill-amber-400 text-amber-400 inline"></i>';

                // Photo HTML
                const photoHtml = place.photoUrl
                    ? `<div class="w-20 h-20 flex-shrink-0 ml-4 rounded-lg overflow-hidden border border-white/10 shadow-lg relative bg-gray-900">
                         <img src="${place.photoUrl}" alt="${place.name}" class="w-full h-full object-cover">
                       </div>`
                    : '';

                // Price Level Logic
                let priceText = '';
                if (place.price_level !== undefined) {
                    // Ref: Google Level 0: Free, 1: Cheap, 2: Moderate, 3: Expensive, 4: Very Expensive
                    // Mapping based on common Japanese Shisha pricing
                    switch (place.price_level) {
                        case 0: priceText = '無料'; break;
                        case 1: priceText = '〜¥2,000'; break;
                        case 2: priceText = '¥2,000〜¥3,000'; break;
                        case 3: priceText = '¥3,000〜¥5,000'; break;
                        case 4: priceText = '¥5,000〜'; break;
                        default: priceText = '';
                    }
                }
                const priceHtml = priceText
                    ? `<span class="text-xs px-2 py-0.5 rounded-full border border-purple-500/50 text-purple-300 bg-purple-900/20">${priceText}</span>`
                    : '';


                card.innerHTML = `
                    <!-- Link Hint -->
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 text-amber-500 text-xs font-bold z-10">
                         <span>経路案内</span>
                         <i data-lucide="navigation" class="w-3 h-3"></i>
                    </div>

                    <div class="flex">
                        <!-- Left Content (Info) -->
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-100 to-amber-400 group-hover:from-amber-200 group-hover:to-amber-500 break-words mr-2">
                                    ${place.name}
                                </h3>
                            </div>

                            <div class="flex items-center gap-3 mb-3 flex-wrap">
                                <div class="flex items-center gap-1">
                                    <div class="flex items-center">${starsHtml}</div>
                                    <span class="text-xs text-gray-400">(${place.reviews})</span>
                                </div>
                                ${priceHtml}
                                <div class="flex items-center gap-1 text-xs text-amber-500 border border-amber-500/30 px-2 py-0.5 rounded">
                                     <i data-lucide="map-pin" class="w-3 h-3"></i>
                                     <span>${place.distance}km</span>
                                </div>
                                <span class="text-xs px-2 py-0.5 rounded-full border ${place.isOpen ? 'border-green-500/50 text-green-400 bg-green-900/20' : 'border-red-500/50 text-red-400 bg-red-900/20'}">
                                    ${place.isOpen ? '営業中' : '営業時間外'}
                                </span>
                            </div>

                             <div class="flex items-start gap-2 text-sm text-gray-300 mb-3">
                                <i data-lucide="map-pin" class="w-4 h-4 mt-0.5 text-amber-500 flex-shrink-0"></i>
                                <span class="line-clamp-1">${place.address}</span>
                            </div>
                        </div>

                        <!-- Right Content (Photo) -->
                        ${photoHtml}
                    </div>
                    
                    <div class="bg-black/30 rounded-lg p-3 border-l-2 border-amber-500 backdrop-blur-sm">
                        <div class="flex items-center gap-2 mb-1">
                             <i data-lucide="message-circle" class="w-3 h-3 text-amber-500"></i>
                             <span class="text-xs font-bold text-amber-500">Pick Up Review</span>
                        </div>
                        <p class="text-xs text-gray-300 italic line-clamp-2">"${place.topReview}"</p>
                    </div>
                `;
                container.appendChild(card);
            });

            // Re-run icons for new elements
            lucide.createIcons();
        }

        // 距離計算Util
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat1)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- Screen Management ---
        function showScreen(screenId) {
            ['landing-screen', 'loading-screen', 'results-screen'].forEach(id => {
                const el = document.getElementById(id);
                if (id === screenId) {
                    el.classList.remove('hidden');
                    el.classList.add('flex');
                    if (id === 'results-screen') {
                        el.classList.remove('flex');
                    }
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                }
            });
        }

        function goBack() {
            showScreen('landing-screen');
        }

        function showError(msg) {
            const loading = document.getElementById('loading-screen');
            loading.classList.add('hidden');
            alert(msg);
            showScreen('landing-screen');
        }

        function updateResultTitle(title) {
            const titleEl = document.querySelector('#results-screen h1');
            if (titleEl) titleEl.textContent = title;
        }

        // --- Modal Functions ---
        function openShopModal(place) {
            // 1. Populate Basic Info
            document.getElementById('modal-shop-name').textContent = place.name;
            document.getElementById('modal-reviews').textContent = `(${place.reviews})`;

            // Stars
            const fullStars = Math.floor(place.rating);
            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) starsHtml += '<i data-lucide="star" class="w-4 h-4 fill-amber-400 text-amber-400 inline"></i>';
            if (place.rating % 1 !== 0) starsHtml += '<i data-lucide="star-half" class="w-4 h-4 fill-amber-400 text-amber-400 inline"></i>';
            document.getElementById('modal-stars').innerHTML = starsHtml;
            lucide.createIcons();

            // Status Badge
            // Re-calculate Open Status for real-time accuracy
            let isShopOpen = place.isOpen;
            if (place.opening_hours_detail) {
                if (place.opening_hours_detail.open_now !== undefined) {
                    isShopOpen = place.opening_hours_detail.open_now;
                } else if (typeof place.opening_hours_detail.isOpen === 'function') {
                    try {
                        isShopOpen = place.opening_hours_detail.isOpen();
                    } catch (e) {
                        console.warn("isOpen() failed", e);
                    }
                }
            }

            // Status Badge
            const badge = document.getElementById('modal-status-badge');
            if (isShopOpen) {
                badge.textContent = '営業中';
                badge.className = 'ml-2 text-xs px-2 py-0.5 rounded-full border border-green-500/50 text-green-400 bg-green-900/20';
            } else {
                badge.textContent = '営業時間外';
                badge.className = 'ml-2 text-xs px-2 py-0.5 rounded-full border border-red-500/50 text-red-400 bg-red-900/20';
            }

            // 2. Action Button
            document.getElementById('modal-directions-btn').onclick = () => openDirections(place.name, place.place_id);

            // 3. Details
            document.getElementById('modal-address').textContent = place.address;

            // Hours
            const hoursList = document.getElementById('modal-hours');
            hoursList.innerHTML = '';
            if (place.opening_hours_detail && place.opening_hours_detail.weekday_text) {
                place.opening_hours_detail.weekday_text.forEach(text => {
                    const li = document.createElement('li');
                    li.textContent = text;
                    hoursList.appendChild(li);
                });
            } else {
                hoursList.innerHTML = '<li>営業時間情報なし</li>';
            }

            // Phone
            const phoneContainer = document.getElementById('modal-phone-container');
            const phoneLink = document.getElementById('modal-phone');
            if (place.phone) {
                phoneContainer.classList.remove('hidden');
                phoneContainer.classList.add('flex');
                phoneLink.textContent = place.phone;
                phoneLink.href = `tel:${place.phone}`;
            } else {
                phoneContainer.classList.add('hidden');
                phoneContainer.classList.remove('flex');
            }

            // Website
            const webContainer = document.getElementById('modal-website-container');
            const webLink = document.getElementById('modal-website');
            if (place.website) {
                webContainer.classList.remove('hidden');
                webContainer.classList.add('flex');
                webLink.textContent = place.website;
                webLink.href = place.website;
            } else {
                webContainer.classList.add('hidden');
                webContainer.classList.remove('flex');
            }

            // Show Modal
            const modal = document.getElementById('shop-detail-modal');
            modal.classList.remove('hidden');
        }

        function closeShopModal() {
            const modal = document.getElementById('shop-detail-modal');
            modal.classList.add('hidden');
        }

    </script>
    <!-- Google Maps API Script: Moved to bottom to ensure initMap is defined -->
    <script id="google-maps-script"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBeydB_GCWyu6XNdLEP5jkpFtNJQXovESM&libraries=places&callback=initMap"
        async defer></script>
</body>

</html>
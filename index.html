<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シーシャどこ？ | Shisha Doko</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="public/favicon.png">

    <style>
        :root {
            --primary: #fbbf24;
            /* Amber 400 */
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #1a1025;
            /* Deep purple bg */
            color: #f3f4f6;
            min-height: 100vh;
            background-image: url('./public/shisha-bg.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden;
        }

        /* Dark Overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 10, 25, 0.85);
            z-index: -1;
        }

        /* Glassmorphism */
        .glass-card {
            background: rgba(40, 30, 60, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 215, 0, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Typography */
        .text-gold-gradient {
            background: linear-gradient(to right, #fde68a, #fbbf24, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Glow Button */
        .glow-btn {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
        }

        .glow-btn:hover {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.7);
            transform: translateY(-2px);
        }

        /* Smoke Animation Support */
        @keyframes drift {
            0% {
                transform: translateY(0) scale(0.5) translateX(-50%);
                opacity: 0;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                transform: translateY(-100px) scale(2) translateX(-20%);
                opacity: 0;
            }
        }

        .smoke-particle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 50px;
            height: 50px;
            background: rgba(128, 128, 128, 0.3);
            border-radius: 50%;
            filter: blur(20px);
            animation: drift 3s infinite ease-in-out;
            pointer-events: none;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center p-4">

    <!-- Screen 1: Landing -->
    <div id="landing-screen"
        class="flex flex-col items-center justify-center w-full max-w-lg transition-opacity duration-500">
        <div class="mb-8 text-center space-y-4">
            <!-- Decorative BG Elements -->
            <div
                class="fixed top-[-10%] left-[-10%] w-[50vh] h-[50vh] bg-purple-900/20 rounded-full blur-[100px] pointer-events-none">
            </div>

            <h1 class="text-5xl md:text-7xl font-bold tracking-tighter text-gold-gradient drop-shadow-lg pb-2">
                シーシャどこ？
            </h1>
            <p class="text-lg text-gray-400 font-medium tracking-wide">
                現在地から、最高のシーシャ体験を。
            </p>
        </div>

        <button onclick="startSearch()"
            class="group relative inline-flex h-14 w-64 items-center justify-center overflow-hidden rounded-full bg-amber-500 px-6 font-medium text-neutral-950 transition-all duration-300 hover:scale-105 hover:bg-amber-400 focus:outline-none glow-btn">
            <i data-lucide="map-pin" class="mr-2 h-5 w-5"></i>
            <span class="tracking-wider text-lg">今すぐ探す</span>
        </button>

        <div class="flex gap-4 text-sm text-gray-500 mt-12">
            <div class="flex items-center gap-1">
                <i data-lucide="sparkles" class="w-4 h-4 text-amber-500"></i>
                <span>★3.5以上の高評価</span>
            </div>
            <div class="flex items-center gap-1">
                <i data-lucide="clock" class="w-4 h-4 text-amber-500"></i>
                <span>5km圏内・営業中のみ</span>
            </div>
        </div>
    </div>

    <!-- Screen 2: Loading (Hidden by default) -->
    <div id="loading-screen" class="hidden flex-col items-center justify-center w-full h-64">
        <div class="relative h-64 w-full flex justify-center items-end">
            <div class="smoke-particle" style="animation-delay: 0s;"></div>
            <div class="smoke-particle" style="animation-delay: 1s;"></div>
            <div class="smoke-particle" style="animation-delay: 2s;"></div>

            <!-- Shisha Base Icon Placeholder -->
            <div
                class="w-8 h-12 border-2 border-amber-500/50 rounded-b-xl relative z-10 bg-slate-900/50 backdrop-blur-sm mb-12">
                <div class="absolute bottom-0 w-full h-1/2 bg-amber-500/20 rounded-b-lg animate-pulse"></div>
            </div>
        </div>
        <p class="text-amber-200/80 font-light tracking-widest text-sm animate-pulse mt-4">検索中...</p>
    </div>

    <!-- Screen 3: Results (Hidden by default) -->
    <div id="results-screen" class="hidden w-full max-w-xl pb-20">
        <div class="flex items-center mb-6 pt-4">
            <button onclick="goBack()" class="mr-4 p-2 rounded-full hover:bg-white/10 transition-colors">
                <i data-lucide="arrow-left" class="w-6 h-6 text-amber-500"></i>
            </button>
            <h1 class="text-2xl font-bold text-gold-gradient">近くのシーシャ屋</h1>
        </div>

        <div id="results-container" class="space-y-4">
            <!-- Cards will be injected here -->
        </div>

        <div id="error-message" class="hidden text-center py-8 text-red-400">
            <p>位置情報を取得できませんでした。</p>
            <button onclick="startSearch()" class="mt-4 underline">再試行</button>
        </div>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        let map;
        let service;
        let userLat, userLng;
        let isApiLoaded = false;

        // APIロード後の初期化
        window.initMap = function () {
            const mapNode = document.createElement('div');
            // 初期座標は仮（東京）
            map = new google.maps.Map(mapNode, { center: { lat: 35.6895, lng: 139.6917 }, zoom: 15 });
            service = new google.maps.places.PlacesService(map);
            isApiLoaded = true;
        }

        // --- Mock Data (Fallback) ---
        // APIキー未設定時用のデモデータ（1km圏内想定）
        // --- Mock Data (Fallback) ---
        // APIキー未設定時用のデモデータ
        const MOCK_PLACES = [
            {
                name: '【デモ】シーシャカフェ 渋谷店',
                rating: 4.8,
                reviews: 120,
                address: '東京都渋谷区...',
                isOpen: true,
                distance: 0.3, // 一番近い
                place_id: '',
                topReview: 'とても落ち着く空間でした。フレーバーの種類も豊富です。'
            },
            {
                name: '【デモ】Hookah Lounge 六本木',
                rating: 4.5,
                reviews: 85,
                address: '東京都港区...',
                isOpen: true,
                distance: 2.5,
                place_id: '',
                topReview: '深夜まで営業していて便利。'
            },
            {
                name: '【デモ】Chill Space 新宿',
                rating: 3.2,
                reviews: 40,
                address: '東京都新宿区...',
                isOpen: true,
                distance: 1.2,
                place_id: '',
                topReview: '駅近でアクセスが良い。'
            },
            {
                name: '【デモ】Shisha Bar 上野',
                rating: 4.0,
                reviews: 200,
                address: '東京都台東区...',
                isOpen: true,
                distance: 4.8, // 遠い
                place_id: '',
                topReview: '賑やかなお店です。'
            },
            {
                name: '【デモ】Hidden Gem 恵比寿',
                rating: 4.9,
                reviews: 10,
                address: '東京都渋谷区...',
                isOpen: true,
                distance: 1.8,
                place_id: '',
                topReview: '隠れ家的な雰囲気。デートにおすすめ。'
            },
            {
                name: '【デモ】遠すぎるシーシャ屋 (表示されないはず)',
                rating: 4.0,
                reviews: 5,
                address: '東京都...',
                isOpen: true,
                distance: 6.0, // 5km圏外
                place_id: '',
                topReview: '遠い...'
            }
        ];

        // 1. トップページで「今すぐ探す」のボタンを押すと現在地のGPS情報を求める
        function startSearch() {
            showScreen('loading-screen');

            // Safety Check: API KeyがデフォルトのままならAPIを呼ばない
            const scriptTag = document.getElementById('google-maps-script');
            if (scriptTag && scriptTag.src.includes('YOUR_API_KEY')) {
                console.warn("API Key not set. Forcing Mock Data.");
                setTimeout(() => {
                    // Mock Data Sorting & Limiting
                    const sortedMock = MOCK_PLACES
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 5);
                    renderResults(sortedMock, true);
                    showScreen('results-screen');
                }, 1500);
                return;
            }

            if (!navigator.geolocation) {
                showError("お使いのブラウザは位置情報をサポートしていません。");
                return;
            }

            // タイムアウト設定 (30秒) + 高精度モード + キャッシュ無効
            const options = {
                enableHighAccuracy: true,
                timeout: 30000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // 2. そこで取得したGPS情報を元に...
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    const userLocation = { lat: userLat, lng: userLng };

                    // check isApiLoaded instead of just window.google
                    if (isApiLoaded && service) {
                        fetchRealPlaces(userLocation);
                    } else {
                        console.warn("Google Maps API not ready. Using fallback.");
                        setTimeout(() => {
                            // Mock Data Sorting & Limiting
                            const sortedMock = MOCK_PLACES
                                .sort((a, b) => a.distance - b.distance)
                                .slice(0, 5);
                            renderResults(sortedMock, true);
                            showScreen('results-screen');
                        }, 1500);
                    }
                },
                (error) => {
                    console.warn("Location failed:", error);
                    let msg = "位置情報の取得に失敗しました。\n";

                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            msg += "エラー: 位置情報の利用が許可されていません。\nブラウザの設定でシーシャどこ？の位置情報利用を許可してください。";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            msg += "エラー: 現在地情報を取得できませんでした。\n電波状況の良い場所でお試しください。";
                            break;
                        case error.TIMEOUT:
                            msg += "エラー: タイムアウトしました。\nもう一度「今すぐ探す」を押してください。";
                            break;
                        default:
                            msg += "エラー: 原因不明のエラーが発生しました。(" + error.message + ")";
                            break;
                    }

                    // HTTPS check warning
                    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                        msg += "\n\n⚠️ 重要: セキュリティ上の理由から、この機能はHTTPS接続（GitHub Pagesなど）でしか動作しない可能性があります。";
                    }

                    alert(msg + "\n\nデモデータを表示します。");

                    // エラー時もデモデータを表示してあげるほうが親切
                    setTimeout(() => {
                        // Mock Data Sorting & Limiting
                        const sortedMock = MOCK_PLACES
                            .sort((a, b) => a.distance - b.distance)
                            .slice(0, 5);
                        renderResults(sortedMock, true);
                        showScreen('results-screen');
                    }, 1000);
                },
                options
            );
        }

        function fetchRealPlaces(location) {
            // 2. Googleマップで「シーシャ」と検索
            // "rankBy: DISTANCE" を使用して、人気順ではなく純粋な距離順で取得する
            // ※ rankBy: DISTANCE を使う場合、radiusは指定できません。
            const request = {
                location: location,
                keyword: 'シーシャ',
                rankBy: google.maps.places.RankBy.DISTANCE,
                openNow: true // 3. 営業中のお店のみ
            };

            try {
                service.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results) {

                        // データ整形とクライアントサイドフィルタリング
                        let candidates = results.map(place => {
                            const distanceKm = getDistanceFromLatLonInKm(
                                location.lat, location.lng,
                                place.geometry.location.lat(),
                                place.geometry.location.lng()
                            );
                            return {
                                name: place.name,
                                rating: place.rating || 0,
                                reviews: place.user_ratings_total || 0,
                                address: place.vicinity || place.formatted_address,
                                isOpen: place.opening_hours ? place.opening_hours.isOpen() : true,
                                distance: Math.round(distanceKm * 100) / 100,
                                place_id: place.place_id,
                                price_level: place.price_level, // Price Level取得
                                topReview: '読み込み中...',
                                geometry: place.geometry
                            };
                        });

                        // 2. レビュー制限を解除 (なるべく多く表示するため)
                        // 4. 5キロ圏内 (Strict filtering)
                        candidates = candidates.filter(p => p.distance <= 5.0);

                        // 距離順にソート
                        candidates.sort((a, b) => a.distance - b.distance);

                        // 5. 最大5つまで表示
                        const finalResults = candidates.slice(0, 5);

                        // --- 詳細情報の取得 (レビュー・写真・価格) ---
                        const detailPromises = finalResults.map(place => {
                            return new Promise((resolve) => {
                                const detailRequest = {
                                    placeId: place.place_id,
                                    fields: ['reviews', 'photos', 'price_level']
                                };
                                service.getDetails(detailRequest, (placeDetails, detailStatus) => {
                                    if (detailStatus === google.maps.places.PlacesServiceStatus.OK) {
                                        // 1. レビュー取得
                                        if (placeDetails.reviews && placeDetails.reviews.length > 0) {
                                            let reviewText = placeDetails.reviews[0].text;
                                            if (reviewText.length > 60) {
                                                reviewText = reviewText.substring(0, 60) + "...";
                                            }
                                            place.topReview = reviewText;
                                        } else {
                                            place.topReview = "（レビューがありません）";
                                        }

                                        // 2. 写真取得
                                        if (placeDetails.photos && placeDetails.photos.length > 0) {
                                            place.photoUrl = placeDetails.photos[0].getUrl({ maxWidth: 400 });
                                        }

                                        // 3. 価格帯取得 (詳細APIから補完)
                                        if (placeDetails.price_level !== undefined) {
                                            place.price_level = placeDetails.price_level;
                                        }
                                    } else {
                                        place.topReview = "（詳細取得エラー）";
                                    }
                                    resolve(place);
                                });
                            });
                        });

                        // 全ての詳細取得が終わったら表示
                        Promise.all(detailPromises).then(updatedResults => {
                            renderResults(updatedResults, false);
                            showScreen('results-screen');
                        });

                    } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                        // 4. お店がない場合
                        renderResults([], false);
                        showScreen('results-screen');
                    } else {
                        console.error("Places Search failed:", status);
                        // エラー時はデモデータを表示
                        alert("検索エラー (Status: " + status + ")\nデモデータを表示します。");
                        setTimeout(() => {
                            renderResults(MOCK_PLACES, true);
                            showScreen('results-screen');
                        }, 1000);
                    }
                });
            } catch (e) {
                console.error("Service Error:", e);
                // Mock Data Sorting & Limiting
                const sortedMock = MOCK_PLACES
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 5);
                renderResults(sortedMock, true);
                showScreen('results-screen');
            }
        }

        // 6. お店をクリックするとGoogleマップで現在地からそのお店までの経路を表示
        function openDirections(name, place_id) {
            // 目的地へのルート検索URL
            // queryに店名、destination_place_idにIDを指定することで精度向上
            const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(name)}&destination_place_id=${place_id}`;
            window.open(url, '_blank');
        }

        function renderResults(places, isMock) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';

            if (isMock) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'bg-red-900/50 text-red-200 border border-red-500/50 p-4 rounded-lg mb-4 text-sm';
                alertDiv.innerHTML = '⚠️ <strong>注意:</strong> Google Maps APIなどが利用できないため、デモデータを表示しています。<br>YOUR_API_KEYの設定や通信環境を確認してください。';
                container.appendChild(alertDiv);
            }

            // 4. 1キロ圏内にお店がない場合は、「周辺にご紹介できるシーシャ屋はありません。」
            if (places.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 space-y-4">
                        <p class="text-lg text-gray-300 font-medium">周辺にご紹介できるシーシャ屋はありません。</p>
                        <p class="text-sm text-gray-500">条件を変更するか、場所を変えて再度お試しください。</p>
                        <button onclick="startSearch()" class="text-amber-500 underline hover:text-amber-400">再検索</button>
                    </div>
                `;
                return;
            }

            places.forEach(place => {
                const card = document.createElement('div');
                card.className = 'glass-card rounded-xl p-6 mb-4 transform transition-all hover:scale-[1.02] hover:bg-white/5 border border-white/10 group animate-fade-in cursor-pointer relative overflow-hidden';

                // 6. クリックで経路表示
                card.onclick = () => openDirections(place.name, place.place_id);

                // Star generation
                const fullStars = Math.floor(place.rating);
                let starsHtml = '';
                for (let i = 0; i < fullStars; i++) starsHtml += '<i data-lucide="star" class="w-4 h-4 fill-amber-400 text-amber-400 inline"></i>';
                if (place.rating % 1 !== 0) starsHtml += '<i data-lucide="star-half" class="w-4 h-4 fill-amber-400 text-amber-400 inline"></i>';

                // Photo HTML
                const photoHtml = place.photoUrl
                    ? `<div class="w-20 h-20 flex-shrink-0 ml-4 rounded-lg overflow-hidden border border-white/10 shadow-lg relative bg-gray-900">
                         <img src="${place.photoUrl}" alt="${place.name}" class="w-full h-full object-cover">
                       </div>`
                    : '';

                // Price Level Logic
                let priceText = '';
                if (place.price_level !== undefined) {
                    // Ref: Google Level 0: Free, 1: Cheap, 2: Moderate, 3: Expensive, 4: Very Expensive
                    // Mapping based on common Japanese Shisha pricing
                    switch (place.price_level) {
                        case 0: priceText = '無料'; break;
                        case 1: priceText = '〜¥2,000'; break;
                        case 2: priceText = '¥2,000〜¥3,000'; break;
                        case 3: priceText = '¥3,000〜¥5,000'; break;
                        case 4: priceText = '¥5,000〜'; break;
                        default: priceText = '';
                    }
                }
                const priceHtml = priceText
                    ? `<span class="text-xs px-2 py-0.5 rounded-full border border-purple-500/50 text-purple-300 bg-purple-900/20">${priceText}</span>`
                    : '';


                card.innerHTML = `
                    <!-- Link Hint -->
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 text-amber-500 text-xs font-bold z-10">
                         <span>経路案内</span>
                         <i data-lucide="navigation" class="w-3 h-3"></i>
                    </div>

                    <div class="flex">
                        <!-- Left Content (Info) -->
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-100 to-amber-400 group-hover:from-amber-200 group-hover:to-amber-500 truncate mr-2">
                                    ${place.name}
                                </h3>
                            </div>

                            <div class="flex items-center gap-3 mb-3 flex-wrap">
                                <div class="flex items-center gap-1">
                                    <div class="flex items-center">${starsHtml}</div>
                                    <span class="text-xs text-gray-400">(${place.reviews})</span>
                                </div>
                                ${priceHtml}
                                <div class="flex items-center gap-1 text-xs text-amber-500 border border-amber-500/30 px-2 py-0.5 rounded">
                                     <i data-lucide="map-pin" class="w-3 h-3"></i>
                                     <span>${place.distance}km</span>
                                </div>
                                <span class="text-xs px-2 py-0.5 rounded-full border border-green-500/50 text-green-400 bg-green-900/20">
                                    営業中
                                </span>
                            </div>

                             <div class="flex items-start gap-2 text-sm text-gray-300 mb-3">
                                <i data-lucide="map-pin" class="w-4 h-4 mt-0.5 text-amber-500 flex-shrink-0"></i>
                                <span class="line-clamp-1">${place.address}</span>
                            </div>
                        </div>

                        <!-- Right Content (Photo) -->
                        ${photoHtml}
                    </div>
                    
                    <div class="bg-black/30 rounded-lg p-3 border-l-2 border-amber-500 backdrop-blur-sm">
                        <div class="flex items-center gap-2 mb-1">
                             <i data-lucide="message-circle" class="w-3 h-3 text-amber-500"></i>
                             <span class="text-xs font-bold text-amber-500">Pick Up Review</span>
                        </div>
                        <p class="text-xs text-gray-300 italic line-clamp-2">"${place.topReview}"</p>
                    </div>
                `;
                container.appendChild(card);
            });

            // Re-run icons for new elements
            lucide.createIcons();
        }

        // 距離計算Util
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat1)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- Screen Management ---
        function showScreen(screenId) {
            ['landing-screen', 'loading-screen', 'results-screen'].forEach(id => {
                const el = document.getElementById(id);
                if (id === screenId) {
                    el.classList.remove('hidden');
                    el.classList.add('flex');
                    if (id === 'results-screen') {
                        el.classList.remove('flex');
                    }
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                }
            });
        }

        function goBack() {
            showScreen('landing-screen');
        }

        function showError(msg) {
            const loading = document.getElementById('loading-screen');
            loading.classList.add('hidden');
            alert(msg);
            showScreen('landing-screen');
        }

    </script>
    <!-- Google Maps API Script: Moved to bottom to ensure initMap is defined -->
    <script id="google-maps-script"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBeydB_GCWyu6XNdLEP5jkpFtNJQXovESM&libraries=places&callback=initMap"
        async defer></script>
</body>

</html>